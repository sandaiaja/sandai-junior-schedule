<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸‰å¤§å°ã‚¸ãƒ¥ãƒ‹ã‚¢ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰ˆ</title>
  <meta name="theme-color" content="#1e3c72">
  <meta name="description" content="ä¸‰å¤§å°ã‚¸ãƒ¥ãƒ‹ã‚¢ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«ã‚¯ãƒ©ãƒ–ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†æ‰‹å‹•å¯¾å¿œç‰ˆï¼‰">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link reAl="stylesheet" href="httpsA://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.css" rel="stylesheet" />
  
  <style>
    /* === ã‚·ã‚¹ãƒ†ãƒ UIã®åŸºæœ¬è‰²ã¨ãƒ•ã‚©ãƒ³ãƒˆ === */
    :root { --primary: #0f3460; --primary-light: #1a5dad; --secondary: #00b4d8; --secondary-light: #48cae4; --accent: #ff5678;
             --background: #f8fafc; --card-bg: #ffffff; --text: #333; --text-light: #666; --success: #10b981; }
    body { background: var(--background); color: var(--text); font-family: 'Noto Sans JP', sans-serif; }

    /* === ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ === */
    .header-container { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 3rem 1rem; border-radius: 20px;
                        color: #fff; text-align: center; position: relative; overflow: hidden; }
    .main-title .title-top { font-size: 2.5rem; font-weight: 900; text-transform: uppercase;
                              text-shadow: 2px 2px 8px rgba(0,0,0,0.4); }
    .main-title .title-middle { font-size: 2rem; margin-top: -0.5rem; opacity: 0.9; }
    .main-title .title-bottom { font-size: 1.8rem; margin-top: -0.5rem; opacity: 0.9; }
    .subtitle { margin-top: 1rem; font-size: 1.1rem; opacity: 0.9; }

    /* === ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ === */
    .system-start-btn { display: inline-block; background: var(--primary); color: #fff; border: none; border-radius: 40px;
                        font-size: 1.2rem; font-weight: 700; padding: 1rem 3rem; margin-top: 2rem; cursor: pointer;
                        box-shadow: 0 8px 20px rgba(0,0,0,0.2); transition: background 0.3s, transform 0.3s;
                        animation: pulse 2.5s infinite; }
    .system-start-btn:hover { background: var(--primary-light); transform: translateY(-3px); }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(15,52,96,0.4); } 70% { box-shadow: 0 0 0 15px rgba(15,52,96,0); } 100% { box-shadow: 0 0 0 0 rgba(15,52,96,0); } }
    
    /* === ãƒ¡ã‚½ãƒƒãƒ‰é¸æŠã‚«ãƒ¼ãƒ‰ === */
    .method-card { background: #fff; border-radius: 16px; padding: 2rem; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
                   transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; }
    .method-card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.15); }
    
    /* === å…¥åŠ›ã‚°ãƒ«ãƒ¼ãƒ— === */
    .input-group label { font-weight: 600; margin-bottom: 0.5rem; display: block; }
    .input-group input, .input-group select, .input-group textarea { width: 100%; border: 2px solid var(--secondary);
                                                  border-radius: 8px; padding: 0.75rem 1rem; }
    /* === ãƒœã‚¿ãƒ³å…¨èˆ¬ === */
    .btn-primary-lg { background: var(--primary); color: #fff; padding: 0.75rem 1.5rem;
                     font-weight: 600; border-radius: 8px; transition: background 0.3s; }
    .btn-primary-lg:hover { background: var(--primary-light); }
    .btn-secondary-lg { background: var(--secondary); color: #fff; padding: 0.75rem 1.5rem;
                       font-weight: 600; border-radius: 8px; transition: background 0.3s; }
    .btn-secondary-lg:hover { background: var(--secondary-light); }
    
    .hidden { display: none !important; }
    .calendar-container { max-width: 600px; margin: 0 auto; }

    /* === æ‰‹å‹•ãƒªãƒ³ã‚¯å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ === */
    #manualLinkInputSection {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px dashed #ccc;
    }
    .event-link-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap; /* å°ç”»é¢ã§æŠ˜ã‚Šè¿”ã™ */
    }
    .event-link-item .event-title-display {
        flex: 1; /* æŸ”è»Ÿãªå¹… */
        font-weight: 500;
        color: var(--text);
        min-width: 150px; /* æœ€å°å¹…ã‚’è¨­å®š */
    }
    .event-link-item input[type="url"] {
        flex: 2; /* æŸ”è»Ÿãªå¹… */
        min-width: 200px; /* æœ€å°å¹…ã‚’è¨­å®š */
        border: 1px solid var(--secondary-light);
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
    }

    /* === ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ (ã‚·ã‚¹ãƒ†ãƒ UIéƒ¨åˆ†) === */
    @media (max-width: 600px) { 
        .event-link-item { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
        .event-link-item .event-title-display, .event-link-item input[type="url"] {
            width: 100%;
            min-width: auto;
        }
    }
  </style>
</head>
<body class="p-6">
  <div class="header-container">
    <div class="main-title">
      <span class="title-top">SANDAI JUNIOR</span><br>
      <span class="title-middle">automatic scheduling</span><br>
      <span class="title-bottom">system</span>
    </div>
    <div class="subtitle">
      <i class="fas fa-volleyball-ball mr-2"></i>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºã‚·ã‚¹ãƒ†ãƒ <i class="fas fa-calendar-alt ml-2"></i>
    </div>
    <button class="system-start-btn" onclick="startSystem()">
      <i class="fas fa-rocket mr-2"></i>system START
    </button>
  </div>

  <div id="methodSelector" class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12 hidden">
    <div class="method-card text-center" onclick="showMethod1()">
      <i class="fas fa-calendar-check text-primary mb-4 text-4xl"></i>
      <h2 class="text-2xl font-bold mb-2">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ & HTMLç”Ÿæˆ</h2>
      <p class="text-text-light">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç¢ºèªã—ãªãŒã‚‰ç”Ÿæˆã—ã¾ã™</p>
    </div>
    <div class="method-card text-center" onclick="showMethod2()">
      <i class="fas fa-clipboard-list text-secondary mb-4 text-4xl"></i>
      <h2 class="text-2xl font-bold mb-2">æ‰‹å‹•è²¼ã‚Šä»˜ã‘æ–¹å¼</h2>
      <p class="text-text-light">JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ç”Ÿæˆã—ã¾ã™</p>
    </div>
  </div>

  <div id="method1" class="hidden mt-12">
    <div class="method-card border-l-4 border-primary">
      <div class="flex items-center mb-6">
        <i class="fas fa-calendar-check text-primary text-3xl mr-3"></i>
        <h2 class="text-2xl font-bold">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ & HTMLç”Ÿæˆ</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="input-group"><label>APIã‚­ãƒ¼</label><input id="apiKey1" type="text" placeholder="APIã‚­ãƒ¼"></div>
        <div class="input-group"><label>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID</label><input id="calendarId1" type="text" placeholder="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID"></div>
        <div class="input-group"><label>å¹´</label><input id="year1" type="number" min="2024" max="2030"></div>
        <div class="input-group"><label>æœˆ</label><select id="month1"></select></div>
      </div>
      <div class="mt-8 flex flex-col sm:flex-row gap-4">
        <button class="btn-secondary-lg flex-1" onclick="fetchAndDisplayEvents()"><i class="fas fa-download mr-2"></i>ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—</button>
        <button class="btn-primary-lg flex-1" onclick="generateHTMLFromAPI()"><i class="fas fa-code mr-2"></i>HTMLç”Ÿæˆ</button>
      </div>
      <div id="autoUrlResult" class="mt-6 hidden">
        <p class="text-success"><i class="fas fa-check-circle mr-1"></i>Google Calendar API URL:</p>
        <a id="calendarUrl" class="text-secondary underline" target="_blank"></a>
      </div>

      <div id="manualLinkInputSection" class="hidden">
        <h3 class="text-xl font-bold mb-4">ã‚¤ãƒ™ãƒ³ãƒˆåˆ¥ãƒªãƒ³ã‚¯å…¥åŠ›</h3>
        <div id="eventLinkInputs">
          </div>
      </div>
      </div>
  </div>

  <div id="method2" class="hidden mt-12">
    <div class="method-card border-l-4 border-secondary">
      <div class="flex items-center mb-6">
        <i class="fas fa-clipboard-list text-secondary text-3xl mr-3"></i>
        <h2 class="text-2xl font-bold">æ‰‹å‹•è²¼ã‚Šä»˜ã‘æ–¹å¼</h2>
      </div>
      <div class="input-group mb-6"><label>JSONãƒ‡ãƒ¼ã‚¿</label><textarea id="jsonData" class="h-40" placeholder="JSONã‚’è²¼ã‚Šä»˜ã‘"></textarea></div>
      <div class="grid grid-cols-2 gap-6">
        <div class="input-group"><label>å¹´</label><input id="year2" type="number" min="2024" max="2030"></div>
        <div class="input-group"><label>æœˆ</label><select id="month2"></select></div>
      </div>
      <div class="mt-8 flex justify-center gap-6">
        <button class="btn-secondary-lg px-8 py-3" onclick="generateFromJSON()"><i class="fas fa-magic mr-2"></i>ç”Ÿæˆ</button>
        <button class="btn-primary-lg px-8 py-3" onclick="backToSelector()"><i class="fas fa-arrow-left mr-2"></i>æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="calendarPreview" class="hidden mt-12">
    <div class="calendar-container"><div id="calendar"></div></div>
    <div class="mt-6 flex justify-center"><button class="btn-primary-lg px-6 py-2" onclick="backToSelector()"><i class="fas fa-arrow-left mr-2"></i>æˆ»ã‚‹</button></div>
  </div>

  <div id="outputSection" class="hidden mt-12">
    <h2 class="text-2xl font-bold text-primary mb-4">ç”Ÿæˆã•ã‚ŒãŸHTMLã‚³ãƒ¼ãƒ‰</h2>
    <textarea id="codeOutput" class="form-control h-60 mb-4"></textarea>
    <div class="flex gap-4 mb-6">
      <button class="btn-secondary-lg px-6 py-3" onclick="copyToClipboard()"><i class="fas fa-copy mr-2"></i>ã‚³ãƒ”ãƒ¼</button>
      <button class="btn-primary-lg px-6 py-3" onclick="backToSelector()"><i class="fas fa-plus mr-2"></i>æ–°è¦ä½œæˆ</button>
    </div>
    <h2 class="text-2xl font-bold text-primary mb-4">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
    <div id="previewSection" class="border p-4 rounded-lg bg-white shadow-inner"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js"></script>
  <script>
    let fetchedEventsData = []; // Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°

    document.addEventListener('DOMContentLoaded', ()=>{
      const now=new Date();
      document.getElementById('year1').value=now.getFullYear();
      document.getElementById('year2').value=now.getFullYear();
      const m1=document.getElementById('month1'), m2=document.getElementById('month2');
      for(let i=1;i<=12;i++){const o1=document.createElement('option');o1.value=i;o1.text=i+'æœˆ';m1.appendChild(o1);
                                       const o2=document.createElement('option');o2.value=i;o2.text=i+'æœˆ';m2.appendChild(o2);}      
      m1.value=now.getMonth()+1; m2.value=now.getMonth()+1;
    });

    function startSystem(){ document.querySelector('.header-container').classList.add('hidden'); document.getElementById('methodSelector').classList.remove('hidden'); }
    function showMethod1(){ 
        document.getElementById('methodSelector').classList.add('hidden'); 
        document.getElementById('method1').classList.remove('hidden'); 
        document.getElementById('manualLinkInputSection').classList.add('hidden'); // éè¡¨ç¤ºã«ã™ã‚‹
        document.getElementById('eventLinkInputs').innerHTML = ''; // ã‚¯ãƒªã‚¢ã™ã‚‹
    }
    function showMethod2(){ 
        document.getElementById('methodSelector').classList.add('hidden'); 
        document.getElementById('method2').classList.remove('hidden'); 
    }
    function backToSelector(){ 
        ['methodSelector','method1','method2','calendarPreview','outputSection'].forEach(id=>document.getElementById(id).classList.add('hidden')); 
        document.querySelector('.header-container').classList.remove('hidden'); 
        fetchedEventsData = []; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
    }
    let generatedURL='';
    function generateAutoURL(){ 
        const key=document.getElementById('apiKey1').value.trim(); 
        const cal=document.getElementById('calendarId1').value.trim(); 
        const y=document.getElementById('year1').value; 
        const m=(''+document.getElementById('month1').value).padStart(2,'0'); 
        if(!key||!cal){alert('APIã‚­ãƒ¼ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;} 
        const days=new Date(y,parseInt(m),0).getDate(); 
        const tmin=`${y}-${m}-01T00:00:00Z`, 
               tmax=`${y}-${m}-${(''+days).padStart(2,'0')}T23:59:59Z`; 
        generatedURL=`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(cal)}/events?key=${encodeURIComponent(key)}&timeMin=${encodeURIComponent(tmin)}&timeMax=${encodeURIComponent(tmax)}&orderBy=startTime&singleEvents=true`; 
        document.getElementById('calendarUrl').href=generatedURL; 
        document.getElementById('calendarUrl').textContent=generatedURL; 
        document.getElementById('autoUrlResult').classList.remove('hidden'); 
        return generatedURL; // URLã‚’è¿”ã™ã‚ˆã†ã«å¤‰æ›´
    }

    async function fetchAndDisplayEvents(){
        const url = generateAutoURL();
        if (!url) return; // URLãŒç”Ÿæˆã•ã‚Œãªã‹ã£ãŸã‚‰å‡¦ç†ã‚’ä¸­æ–­

        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText} - ${errorText}`);
            }
            const data = await response.json();
            
            if (!data.items || data.items.length === 0) {
                alert('æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                document.getElementById('calendarPreview').classList.add('hidden');
                document.getElementById('manualLinkInputSection').classList.add('hidden');
                return;
            }

            fetchedEventsData = data.items; // å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            document.getElementById('calendarPreview').classList.remove('hidden');
            const calendarEl = document.getElementById('calendar');
            // æ—¢å­˜ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒã‚ã‚Œã°ç ´æ£„ã—ã¦å†ä½œæˆï¼ˆå¤šé‡ã«æç”»ã•ã‚Œã‚‹ã®ã‚’é˜²ãï¼‰
            // FullCalendar.getCalendarById ãŒé–¢æ•°ã¨ã—ã¦å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (typeof FullCalendar.getCalendarById === 'function') {
                const existingCalendar = FullCalendar.getCalendarById(calendarEl.getAttribute('data-fc-id'));
                if (existingCalendar) {
                    existingCalendar.destroy();
                }
            } else {
                // getCalendarById ãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
                console.warn("FullCalendar.getCalendarById is not available. Clearing calendar element content as a fallback.");
                calendarEl.innerHTML = ''; 
            }

            const cal = new FullCalendar.Calendar(calendarEl, {
                initialView:'dayGridMonth',
                locale:'ja',
                headerToolbar:{left:'prev,next today',center:'title'},
                events:fetchedEventsData.map(e=>({
                    title:e.summary||'ç„¡é¡Œ',
                    start:e.start.dateTime||e.start.date,
                    end:e.end.dateTime||e.end.date,
                    allDay:!e.start.dateTime
                }))
            }); 
            cal.render();

            // ã‚¤ãƒ™ãƒ³ãƒˆåˆ¥ãƒªãƒ³ã‚¯å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ç”Ÿæˆ
            displayManualLinkInputs(fetchedEventsData);

        } catch (error) {
            console.error('ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            alert('ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nAPIã‚­ãƒ¼ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼è©³ç´°: ' + error.message);
            document.getElementById('calendarPreview').classList.add('hidden');
            document.getElementById('manualLinkInputSection').classList.add('hidden');
        }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã®ãƒªãƒ³ã‚¯å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    function displayManualLinkInputs(events) {
        const inputSection = document.getElementById('manualLinkInputSection');
        const eventLinkInputsDiv = document.getElementById('eventLinkInputs');
        eventLinkInputsDiv.innerHTML = ''; // æ—¢å­˜ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢

        if (events.length > 0) {
            inputSection.classList.remove('hidden');
            // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ (å†åº¦)
            events.sort((a,b)=>new Date(a.start.dateTime||a.start.date)-new Date(b.start.dateTime||b.start.date));

            events.forEach((event, index) => {
                const eventSummary = event.summary || 'ç„¡é¡Œ';
                const dateObj = new Date(event.start.dateTime || event.start.date);
                const eventDateDisplay = `${dateObj.getMonth()+1}/${dateObj.getDate()}`; // è¡¨ç¤ºç”¨ã®æ—¥ä»˜å½¢å¼
                
                // ãƒªãƒ³ã‚¯ã‚­ãƒ¼ç”Ÿæˆ (YYYY-MM-DD-SUMMARY)
                const eventLinkKey = `${dateObj.getFullYear()}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}-${dateObj.getDate().toString().padStart(2,'0')}-${eventSummary}`;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'event-link-item';
                itemDiv.innerHTML = `
                    <div class="event-title-display">${eventDateDisplay} - ${eventSummary}</div>
                    <input type="url" id="link-input-${index}" data-event-key="${eventLinkKey}" placeholder="ãƒªãƒ³ã‚¯URL (ä¾‹: https://example.com/details)" class="url-input" />
                `;
                eventLinkInputsDiv.appendChild(itemDiv);
            });
        } else {
            inputSection.classList.add('hidden');
        }
    }

    // HTMLç”Ÿæˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã‚’ä¿®æ­£
    function generateHTMLFromAPI(){
        if (fetchedEventsData.length === 0) {
            alert('ã¾ãšã€Œã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const manualLinks = [];
        document.querySelectorAll('#eventLinkInputs .url-input').forEach(input => {
            if (input.value.trim() !== '') {
                const eventKey = input.dataset.eventKey; // data-event-keyã‹ã‚‰ã‚­ãƒ¼ã‚’å–å¾—
                const url = input.value.trim();
                
                // manualLinksã«ã¯ã€keyã¨urlã®å½¢å¼ã§æ ¼ç´
                manualLinks.push({key: eventKey, url: url});
            }
        });
        // manualLinksã‚’Mapã«å¤‰æ›ã—ã¦ generateFromItems ã«æ¸¡ã™
        const manualLinkMap = new Map();
        manualLinks.forEach(link => manualLinkMap.set(link.key, link.url));

        generateFromItems(fetchedEventsData, manualLinkMap);
    }

    // generateFromJSON ã®å‘¼ã³å‡ºã—ã‚‚ä¿®æ­£
    function generateFromJSON(){ 
        const j=document.getElementById('jsonData').value.trim(); 
        if(!j){alert('JSONã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return;} 
        const parsedData = JSON.parse(j);
        
        // JSONã®manualLinksã‚’Mapã«å¤‰æ›
        const jsonManualLinkMap = new Map();
        if (parsedData.manualLinks) {
            parsedData.manualLinks.forEach(link => {
                const dateKey = `${link.date}-${link.summary}`; // JSONã‹ã‚‰æ¸¡ã•ã‚Œã‚‹å½¢å¼
                jsonManualLinkMap.set(dateKey, link.url);
            });
        }
        generateFromItems(parsedData.items || [], jsonManualLinkMap); 
    }

    // manualLinksMap ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã€æ‰‹å‹•ãƒªãƒ³ã‚¯é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£
    function generateFromItems(items, manualLinksMap = new Map()){ 
        const monthNames=['','1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'], 
              dayNames=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ']; 
        items.sort((a,b)=>new Date(a.start.dateTime||a.start.date)-new Date(b.start.dateTime||b.start.date)); 
        let list='', camps=new Set(); 
        
        items.forEach(e=>{
            const sd=new Date(e.start.dateTime||e.start.date), 
                  ed=new Date(e.end.dateTime||e.end.date); 
            let cls='', t=e.summary||'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'; 
            
            // æ‰‹å‹•ãƒªãƒ³ã‚¯ã®æ¤œç´¢ã‚­ãƒ¼ã‚’ä½œæˆ (YYYY-MM-DD-SUMMARY)
            const eventDateFormatted = sd.toISOString().slice(0, 10); // YYYY-MM-DD
            const eventLinkKey = `${eventDateFormatted}-${t}`;
            const manualLink = manualLinksMap.get(eventLinkKey); // ã“ã“ã§æ‰‹å‹•ãƒªãƒ³ã‚¯ã‚’å–å¾—

            let contentHtml = '';

            if(/è©¦åˆ/.test(t) && !/ç·´ç¿’è©¦åˆ/.test(t)) cls='match'; 
            else if(/ç·´ç¿’è©¦åˆ/.test(t)) cls='practice-match';
            else if(/å¤§ä¼š/.test(t)) cls='tournament';
            else if(/åˆå®¿/.test(t)) cls='camp'; 
            else if(/ä¼‘/.test(t)) cls='no-practice'; 
            else if(/ç·´ç¿’/.test(t)) cls='practice'; 
            
            if(cls==='camp'){ 
                const k=t+sd.getTime(); 
                if(camps.has(k)) return; 
                camps.add(k); 
                
                const sdD=sd.getDate(), 
                      edD=new Date(ed.getTime()-86400000).getDate(); 
                const startMonth = sd.getMonth() + 1;
                const endMonth = new Date(ed.getTime() - 86400000).getMonth() + 1;
                
                let dStr, dayStr;
                if (sdD === edD) { // å˜æ—¥åˆå®¿
                    dStr = `${startMonth}/${sdD}`;
                    dayStr = dayNames[sd.getDay()];
                } else { // è¤‡æ•°æ—¥åˆå®¿
                    if (startMonth === endMonth) { // åŒã˜æœˆå†…
                        dStr = `${startMonth}/${sdD}ï½${edD}`;
                    } else { // æœˆã‚’ã¾ãŸãå ´åˆ
                        dStr = `${startMonth}/${sdD}ï½${endMonth}/${edD}`;
                    }
                    dayStr = `${dayNames[sd.getDay()]}ï½${dayNames[new Date(ed.getTime()-86400000).getDay()]}`;
                }

                // æ‰‹å‹•ãƒªãƒ³ã‚¯ãŒã‚ã‚Œã° <a> ã‚¿ã‚°ã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã° <span> ã‚¿ã‚°
                contentHtml = manualLink ? 
                    `<a href="${manualLink}" target="_blank" rel="noopener noreferrer" class="${cls}">ğŸ•ï¸ ${t} ğŸ</a>` :
                    `<span class="${cls}">ğŸ•ï¸ ${t} ğŸ</span>`; 
                list+=`<li class="schedule-item"><div class="date">${dStr}(${dayStr})</div><div class="content">${contentHtml}</div></li>`;
            } else {
                const dStr=`${sd.getMonth()+1}/${sd.getDate()}`, 
                      dayStr=dayNames[sd.getDay()], 
                      timeStr=e.start.dateTime?` ${sd.toTimeString().slice(0,5)}-${ed.toTimeString().slice(0,5)}`:''; 
                
                // æ‰‹å‹•ãƒªãƒ³ã‚¯ãŒã‚ã‚Œã° <a> ã‚¿ã‚°ã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã° <span> ã‚¿ã‚°
                contentHtml = manualLink ?
                    `<a href="${manualLink}" target="_blank" rel="noopener noreferrer" class="${cls}">${t}${timeStr}</a>` :
                    `<span class="${cls}">${t}${timeStr}</span>`;
                list+=`<li class="schedule-item"><div class="date">${dStr}(${dayStr})</div><div class="content">${contentHtml}</div></li>`;
            }
        }); 

        const currentYear = document.getElementById('year1')?.value || document.getElementById('year2')?.value || new Date().getFullYear();
        const currentMonth = document.getElementById('month1')?.value || document.getElementById('month2')?.value || (new Date().getMonth() + 1);

        // WordPressã«åŸ‹ã‚è¾¼ã‚€ãŸã‚ã®CSSã‚’wpCsså¤‰æ•°ã«å†å®šç¾©
        const wpCss=`<style>
/* WordPresså¯¾å¿œå¼·åŒ–CSS - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤ºéƒ¨åˆ†ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆWordPressåŸ‹ã‚è¾¼ã¿ç”¨ï¼‰ */
.schedule-container { max-width: 600px !important; margin: 20px auto !important; background: #fff !important; border: 1px solid #ddd !important; border-radius: 8px !important; overflow: hidden !important; box-shadow: 0 5px 15px rgba(0,0,0,0.05) !important; font-family: 'Noto Sans JP', sans-serif !important; color: #333 !important; }
.schedule-title { background: linear-gradient(135deg, #4a90e2, #2563eb) !important; color: white !important; text-align: center !important; padding: 12px !important; margin: 0 !important; font-size: 1.25rem !important; font-weight: 700 !important; }
.schedule-list { list-style: none !important; padding: 0 !important; margin: 0 !important; }
.schedule-item { display: flex !important; align-items: center !important; padding: 10px 16px !important; border-bottom: 1px solid #eee !important; transition: background 0.2s !important; }
.schedule-item:hover { background: #f9f9ff !important; }
.schedule-item:last-child { border-bottom: none !important; }
.schedule-container .date { font-weight: bold !important; color: #333 !important; min-width: 80px !important; margin-right: 12px !important; background: #f0f0f0 !important; padding: 4px 8px !important; border-radius: 4px !important; font-size: 0.875rem !important; text-align: center !important; }
.schedule-container .content { flex: 1 !important; color: #666 !important; }
.schedule-container .practice { color: #2e7d32 !important; font-weight: 500 !important; text-decoration: none !important; }
.schedule-container .practice:hover { color: #1b5e20 !important; text-decoration: underline !important; }
.schedule-container .practice-match, 
.schedule-container a.practice-match,
.schedule-item .practice-match,
.schedule-item a.practice-match,
.content .practice-match,
.content a.practice-match { 
  color: #1976d2 !important; 
  font-weight: bold !important; 
  text-decoration: none !important; 
}
.schedule-container .practice-match:hover,
.schedule-container a.practice-match:hover,
.schedule-item .practice-match:hover,
.schedule-item a.practice-match:hover,
.content .practice-match:hover,
.content a.practice-match:hover { 
  color: #1565c0 !important; 
  text-decoration: underline !important; 
}
.schedule-container .no-practice { color: #616161 !important; text-decoration: none !important; }
.schedule-container .no-practice:hover { color: #9e9e9e !important; text-decoration: underline !important; }
/* ãƒªãƒ³ã‚¯ãŒè²¼ã‚‰ã‚ŒãŸè¦ç´ ã®åŸºæœ¬çš„ãªã‚¹ã‚¿ã‚¤ãƒ« */
.schedule-container a { 
    text-decoration: none !important; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸‹ç·šã‚’ãªãã™ */
    color: inherit !important; /* è¦ªè¦ç´ ã®è‰²ã‚’ç¶™æ‰¿ */
}
.schedule-container a:visited { 
    color: inherit !important; /* è¨ªå•æ¸ˆã¿ã®ãƒªãƒ³ã‚¯ã‚‚è‰²ã‚’ç¶™æ‰¿ */
}

/* camp ã‚¯ãƒ©ã‚¹ã®è¦ç´ ã€ãŠã‚ˆã³ãã‚ŒãŒãƒªãƒ³ã‚¯ã®å ´åˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
.schedule-container .camp, 
.schedule-container a.camp,
.schedule-item .camp,
.schedule-item a.camp,
.content .camp,
.content a.camp { 
  background: linear-gradient(135deg, #ff6b35, #f7931e, #ffcc02) !important; 
  color: white !important; 
  padding: 12px 20px !important; 
  border-radius: 25px !important; 
  font-weight: bold !important; 
  font-size: 1.1em !important;
  box-shadow: 0 8px 16px rgba(255, 107, 53, 0.3), 0 4px 8px rgba(0, 0, 0, 0.1) !important;
  border: 2px solid #fff !important;
  display: inline-block !important;
  margin: 4px 0 !important;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2) !important;
  transform: translateY(-2px) !important;
  transition: all 0.3s ease !important;
  animation: campPulse 2s infinite !important;
  text-decoration: none !important; /* ãƒªãƒ³ã‚¯ã®ä¸‹ç·šã‚’ãªãã™ */
  line-height: 1.2 !important;
  cursor: pointer !important;
}
.schedule-container .camp:hover,
.schedule-container a.camp:hover,
.schedule-item .camp:hover,
.schedule-item a.camp:hover,
.content .camp:hover,
.content a.camp:hover {
  transform: translateY(-4px) !important;
  box-shadow: 0 12px 24px rgba(255, 107, 53, 0.4), 0 6px 12px rgba(0, 0, 0, 0.15) !important;
  background: linear-gradient(135deg, #ff8c5a, #ffa43e, #ffd633) !important;
  color: white !important;
}
@keyframes campPulse {
  0% { box-shadow: 0 8px 16px rgba(255, 107, 53, 0.3), 0 4px 8px rgba(0, 0, 0, 0.1) !important; }
  50% { box-shadow: 0 12px 24px rgba(255, 107, 53, 0.5), 0 6px 12px rgba(0, 0, 0, 0.2) !important; }
  100% { box-shadow: 0 8px 16px rgba(255, 107, 53, 0.3), 0 4px 8px rgba(0, 0, 0, 0.1) !important; }
}

/* matchï¼ˆè©¦åˆï¼‰ã‚¯ãƒ©ã‚¹ã®è¦ç´ ã€ãŠã‚ˆã³ãã‚ŒãŒãƒªãƒ³ã‚¯ã®å ´åˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
.schedule-container .match, 
.schedule-container a.match,
.schedule-item .match,
.schedule-item a.match,
.content .match,
.content a.match { 
  background: linear-gradient(135deg, #e63946, #f77f00, #fcbf49) !important; 
  color: white !important; 
  padding: 10px 18px !important; 
  border-radius: 20px !important; 
  font-weight: bold !important; 
  font-size: 1.05em !important;
  box-shadow: 0 6px 12px rgba(230, 57, 70, 0.3), 0 3px 6px rgba(0, 0, 0, 0.1) !important;
  border: 2px solid #fff !important;
  display: inline-block !important;
  margin: 3px 0 !important;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2) !important;
  transform: translateY(-1px) !important;
  transition: all 0.3s ease !important;
  animation: matchPulse 2.5s infinite !important;
  text-decoration: none !important; /* ãƒªãƒ³ã‚¯ã®ä¸‹ç·šã‚’ãªãã™ */
  line-height: 1.2 !important;
  cursor: pointer !important;
}
.schedule-container .match:hover,
.schedule-container a.match:hover,
.schedule-item .match:hover,
.schedule-item a.match:hover,
.content .match:hover,
.content a.match:hover {
  transform: translateY(-3px) !important;
  box-shadow: 0 10px 20px rgba(230, 57, 70, 0.4), 0 5px 10px rgba(0, 0, 0, 0.15) !important;
  background: linear-gradient(135deg, #f16068, #f89500, #fcc464) !important;
  color: white !important;
}
@keyframes matchPulse {
  0% { box-shadow: 0 6px 12px rgba(230, 57, 70, 0.3), 0 3px 6px rgba(0, 0, 0, 0.1) !important; }
  50% { box-shadow: 0 10px 20px rgba(230, 57, 70, 0.5), 0 5px 10px rgba(0, 0, 0, 0.2) !important; }
  100% { box-shadow: 0 6px 12px rgba(230, 57, 70, 0.3), 0 3px 6px rgba(0, 0, 0, 0.1) !important; }
}

/* tournamentï¼ˆå¤§ä¼šï¼‰ã‚¯ãƒ©ã‚¹ã®è¦ç´ ã€ãŠã‚ˆã³ãã‚ŒãŒãƒªãƒ³ã‚¯ã®å ´åˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
.schedule-container .tournament, 
.schedule-container a.tournament,
.schedule-item .tournament,
.schedule-item a.tournament,
.content .tournament,
.content a.tournament { 
  background: linear-gradient(135deg, #6f42c1, #8e44ad, #c39bd3) !important; 
  color: white !important; 
  padding: 14px 22px !important; 
  border-radius: 30px !important; 
  font-weight: bold !important; 
  font-size: 1.15em !important;
  box-shadow: 0 10px 20px rgba(111, 66, 193, 0.3), 0 5px 10px rgba(0, 0, 0, 0.1) !important;
  border: 3px solid #fff !important;
  display: inline-block !important;
  margin: 5px 0 !important;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3) !important;
  transform: translateY(-3px) !important;
  transition: all 0.3s ease !important;
  animation: tournamentPulse 2s infinite !important;
  text-decoration: none !important; /* ãƒªãƒ³ã‚¯ã®ä¸‹ç·šã‚’ãªãã™ */
  line-height: 1.2 !important;
  cursor: pointer !important;
  position: relative !important;
}
.schedule-container .tournament::before,
.schedule-container a.tournament::before,
.schedule-item .tournament::before,
.schedule-item a.tournament::before,
.content .tournament::before,
.content a.tournament::before {
  content: 'ğŸ†' !important;
  font-size: 1.2em !important;
  margin-right: 8px !important;
  animation: trophyGlow 1.5s infinite alternate !important;
}
.schedule-container .tournament:hover,
.schedule-container a.tournament:hover,
.schedule-item .tournament:hover,
.schedule-item a.tournament:hover,
.content .tournament:hover,
.content a.tournament:hover {
  transform: translateY(-5px) scale(1.02) !important;
  box-shadow: 0 15px 30px rgba(111, 66, 193, 0.4), 0 8px 16px rgba(0, 0, 0, 0.15) !important;
  background: linear-gradient(135deg, #8e44ad, #9b59b6, #d2b4de) !important;
  color: white !important;
}
@keyframes tournamentPulse {
  0% { box-shadow: 0 10px 20px rgba(111, 66, 193, 0.3), 0 5px 10px rgba(0, 0, 0, 0.1) !important; }
  50% { box-shadow: 0 15px 30px rgba(111, 66, 193, 0.5), 0 8px 16px rgba(0, 0, 0, 0.2) !important; }
  100% { box-shadow: 0 10px 20px rgba(111, 66, 193, 0.3), 0 5px 10px rgba(0, 0, 0, 0.1) !important; }
}
@keyframes trophyGlow {
  0% { filter: brightness(1) !important; }
  100% { filter: brightness(1.3) drop-shadow(0 0 5px gold) !important; }
}
@media (max-width: 600px) { 
  .schedule-container { margin: 10px !important; } 
  .schedule-item { flex-direction: column !important; align-items: flex-start !important; } 
  .schedule-container .date { margin-bottom: 8px !important; width: 100% !important; } 
}
</style>`; 
        
        const html=`${wpCss}<div class="schedule-container"><h2 class="schedule-title">ğŸ“… ${currentYear}å¹´${monthNames[currentMonth]}ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2><ul class="schedule-list">${list}</ul></div>`; 
        document.getElementById('codeOutput').value=html; 
        document.getElementById('previewSection').innerHTML=html; 
        backToSelector(); 
        document.getElementById('outputSection').classList.remove('hidden'); 
    }
    function copyToClipboard(){ navigator.clipboard.writeText(document.getElementById('codeOutput').value); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
  </script>
</body>
</html>
